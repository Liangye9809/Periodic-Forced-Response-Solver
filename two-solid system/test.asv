t = [0:100] * (2*pi/100);
y1 = exp(t/2);
plot(t,y1);
grid on;

%% test handle variables
clear testfunc
testfunc.fc = CoulombFrictionParas(Coulombstruct);
testfunc.fc.w = CoulombFrictionW([1;1], Nx);




function F = testgf(x, p)
    fc = p.fc;

    kn = fc.kn; % 
    xn0 = fc.xn0; 
    mu = fc.mu; % 
    kt = fc.kt; % 
    w = fc.w;

    w = w + 1;
    
    fc.w = w;

    F = w;
end
%%
tic
testF = g(rand(256,17), 0);
toc
%%
% clc
disp(['dt   ','nsteps   ','']);
clear J
J = finite_diff_jac(@(x) gf(x, params.func).F, xp);
J = [zeros(5,17);
      zeros(12,5), J];
J = -M \ J;
Jg = [zeros(17,17), zeros(17,17);
      J, zeros(17,17)];
T = 2*pi / omega_0;
for i  = 0:8
    nsteps = 100 * 10^i;
    dt = T / nsteps;

    % explicit Euler exponential numerical method
    dtA = dt * A;
    R_ExpEulxpm = expm(dtA) + dt * expm(dtA) * Jg;
    e_ExpEulxpm = eig(R_ExpEulxpm);
    maxe_ExpEulxpm = max(abs(e_ExpEulxpm));

    % % RK2 exponential numerical method
    % RK2R = dt * A + dt^2 / 2 * A^2 + eye(34);
    % maxeRK2 = max(abs(eig(RK2R)));


    % Implicit Euler Method
    R_ImpEulxpm = inv(eye(34) - dt*(A + Jg));
    e_ImpEulxpm = eig(R_ImpEulxpm);
    maxe_ImpEulxpm = max(abs(e_ImpEulxpm));
    
    
    disp([dt, nsteps, maxe_ExpEulxpm, max(abs(e_ImpEulxpm))]);
end
%% 
t = -1:0.001:1;
y = sqrt(abs(t));
plot(t,y)
%%
a_1 = 11/6;
a0 = -3;
a1 = 3/2;
a2 = -1/3;
f1 = a_1 + a0 + a1 + a2;
f2 = a0 + 2*a1 + 3*a2;
f3 = a0 + 4*a1 + 9*a2;
f4 = a0 + 8*a1 + 27*a2;
%%
for i  = 8:8
    nsteps = 14500;
    dt = T / nsteps;
    R_ExpEulxpm = eye(34) + (dt/2)*A;
    format short g
    disp([dt, nsteps, max(max(abs(R_ExpEulxpm))), max(max(abs(eig(R_ExpEulxpm))))]);
end

%% test g only
clear
load("ptest.mat");
N = 2^3;
Nx = 4;
xtest = zeros(N, 3 * Nx);
fc.kn = ptest.fc.kn;
fc.xn0 = ptest.fc.xn0;
fc.mu = ptest.fc.mu;
fc.kt = ptest.fc.kt;
fc.w = ptest.fc.w;
for i = 1:N
    for j = 1:(3 * Nx)
        xtest(i, j) = 12 * (i -1) + j;
    end
end
profile on
tic;
for i = 1:1
    F = g_mex(xtest, fc);
end
toc;
profile off
p = profile('info');
profview(0,p);

%%
clear
load("fc_row.mat");
N = 2^8;
Nx = 4;
xtest = rand(N, 3 * Nx);

tic;
for i = 1:1000
    % [F, w] = g_mex(xtest, fc);
    F = Getgx(xtest, fc);
    % F = SeletF(g_mex(xtest, fc));
end
toc;

%%
%% test if CB modes and matrices are the same with doc.
% read from file
clear
ReadFromCSV;
CB_doc = CB;
Rx_doc = Rx;
xe0_doc = xe0;

% calculate from Mee file
Data;
CriagBamptonReduction;

%% compare CBmodes
eps_Kaa = norm(CB_doc.CBmods.Kaa - CB.CBmods.Kaa) / norm(CB.CBmods.Kaa)
eps_Psi = norm(full(CB_doc.CBmods.Psi - CB.CBmods.Psi)) / norm(full(CB.CBmods.Psi))
eps_Phi = norm(full(CB_doc.CBmods.Phi - CB.CBmods.Phi)) / norm(full(CB.CBmods.Phi))
eps_Max = norm(full(CB_doc.CB_MK.Max - CB.CB_MK.Max)) / norm(full(CB.CB_MK.Max))
eps_Mxx = norm(full(CB_doc.CB_MK.Mxx - CB.CB_MK.Mxx)) / norm(full(CB.CB_MK.Mxx))
eps_Kxx = norm(full(CB_doc.CB_MK.Kxx - CB.CB_MK.Kxx)) / norm(full(CB.CB_MK.Kxx))
eps_Fa = norm(full(CB_doc.CB_F.Fa - CB.CB_F.Fa)) / norm(full(CB.CB_F.Fa))
eps_Fx = norm(full(CB_doc.CB_F.Fx - CB.CB_F.Fx)) / norm(full(CB.CB_F.Fx))

eps_Rx = norm(Rx_doc - Rx) / norm(Rx)
eps_xe0 = norm(xe0_doc - xe0) / norm(xe0)

%% full stuck frq by increasing contact pairs
% clear
% c = jet(5);
% for j = 1:5
%     figure;
%     for i = 4:4:36
%         names = 'full_stuck_modes_CP' + string(i) + '.mat';
%         load(names);
%         plot(i, sqrt(e(j)), 'Color', c(j,:), 'Marker', 'o','MarkerFaceColor', c(j,:)), hold on;
%     end
%     grid on;
%     xlabel('number of contact pairs');
%     ylabel('Omega_' + string(j));
%     title('frequency of mode ' + string(j) + ' VS number of contact pairs');
% end

clear
close all
frqs = zeros(20,9);
for i = 4:4:36
    names = 'full_stuck_modes_CP' + string(i) + '.mat';
    load(names);
    frqs(:, i/4) = e;
end

% figure
% c = jet(5);
% CP = [4:4:36];
% for i = 1:5
%     plot(CP, frqs(i, :), 'Color', c(i,:), 'Marker', 'o','MarkerFaceColor', c(i,:), 'LineStyle', '-'), hold on;
% end
% xlabel('number of contact pairs');
% ylabel('Omega');
% title('frequency of first 5 modes VS number of contact pairs');
% grid on;

% path = pwd;
% cd ../pictures/NewMesh/
c = jet(5);
CP = [4:4:36];

for i = 1:5
    figure
    plot(CP, sqrt(frqs(i, :)), 'Color', c(i,:), 'Marker', 'o','MarkerFaceColor', c(i,:), 'LineStyle', '-'), hold on;

    xlabel('number of contact pairs');
    ylabel('Omega_' + string(i));
    titlename = 'frequency of mode ' + string(i) + ' VS number of contact pairs';
    title(titlename);
    grid on;
    % savefig(titlename);
end

%% plot a1 resonance curve - lower Adof - average preload in all contacts
figure
for i = 4:4:36
    names = 'data/NewMesh/Lower_Adof_CP' + string(i) + '.mat';
    load(names);
    plot(Adof(:,1), Adof(:,3)), hold on;
end
grid on;
xlabel('Omega');
ylabel('|a1|');
legend('CP4', 'CP8', 'CP12', 'CP16', 'CP20', 'CP24', 'CP28', 'CP32', 'CP36')

%% plot a1 resonance curve - preload act only in first 4 contacts
figure
for i = 4:4:24
    names = 'data/NewMesh/Adof_CP' + string(i) + '.mat';
    load(names);
    plot(Adof(:,1), Adof(:,3)), hold on;
end
grid on;
xlabel('Omega');
ylabel('|a1|');
legend('CP4', 'CP8', 'CP12', 'CP16', 'CP20', 'CP24')

%% the difference of two Rx
Rx = zeros(3*36, 2*8);
j = 1;
for Nx = 8:4:36
    dataname = 'FEM/CP' + string(Nx) + '.mat';
    load(dataname);

    Xcn0 = zeros(3*Nx, 1);
    X00 = [0,0,0.001]';
    for i = 1:Nx
        Xcn0(3 * i - 2:3 * i) = X00;
    end

    FEM.Pe = FEM.Kec * Xcn0 ./ (Nx/4);
    FEM.Pc = FEM.Kcc * Xcn0 ./ (Nx/4);
    xe0 = FEM.Kee \ FEM.Pe; 
    Rx2 = FEM.Kec' * xe0 - FEM.Pc; 


    Rx(1:3*Nx, 2*j - 1) = Rx2;
    j = j + 1;
end

j = 1;
for Nx = 8:4:36
    dataname = 'FEM/CP' + string(Nx) + '.mat';
    load(dataname);

    Xcn0 = zeros(3*Nx, 1);
    X00 = [0,0,0.001]';
    for i = 1:4
        Xcn0(3 * i - 2:3 * i) = X00;
    end

    FEM.Pe = FEM.Kec * Xcn0;
    FEM.Pc = FEM.Kcc * Xcn0;
    xe0 = FEM.Kee \ FEM.Pe; 
    Rx2 = FEM.Kec' * xe0 - FEM.Pc; 

    
    Rx(1:3*Nx, 2*j) = Rx2;
    j = j + 1;
end

%% rename the file
for i = 4:4:36
    oldfilename = 'data/NewMesh/Adof_CP' + string(i) + '_PreDisAll.mat';
    newfilename = 'data/NewMesh/Adof_CP' + string(i) + '_PreDisAllDiv.mat';
    movefile(oldfilename, newfilename);
end
%% rename the file test
movefile('oldfilename.m', 'newfilename.m');